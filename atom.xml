<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>eshenhu&#39;s blog</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://eshenhu.github.io/"/>
  <updated>2017-06-11T02:43:16.000Z</updated>
  <id>https://eshenhu.github.io/</id>
  
  <author>
    <name>eshenhu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Efficient data transfer through zero copy</title>
    <link href="https://eshenhu.github.io/2017/06/05/Efficient-data-transfer-through-zero-copy/"/>
    <id>https://eshenhu.github.io/2017/06/05/Efficient-data-transfer-through-zero-copy/</id>
    <published>2017-06-04T16:21:11.000Z</published>
    <updated>2017-06-11T02:43:16.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Zero-copy-I-O-practice-in-project"><a href="#Zero-copy-I-O-practice-in-project" class="headerlink" title="Zero-copy I/O practice in project"></a>Zero-copy I/O practice in project</h2><p>Recently weeks, I was working on how to exploit the potentialities with the GMAC(1G Ethernet Media Access Controller)  on the SoC in my desktop. This SoC was used in the telecommunication field which provide the fast-transfer-data capability with some interesting MAC features. In this article, I had like share some experiences on how to utilize this MAC achieving better network throughput during this work.</p>
<h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>@[Blog]</p>
<p>The following articles were worth having a look before going forward.</p>
<ul>
<li><a href="http://www.linuxjournal.com/article/6345" target="_blank" rel="external">Zero Copy I: User-Mode Perspective </a> (from Linux Journal, strongly recommended to read)</li>
<li><a href="http://dl.acm.org/citation.cfm?id=974947" target="_blank" rel="external">An Efficient Zero-Copy I/O Framework for UNIX</a> (most of thoughts comes from here)</li>
</ul>
<a id="more"></a>
<p>After reading these articles, then you will know how the Java.nio.channels works. If you have more time, you can dig more on the Kafaka, the most popular message queue framework written by LinkedIn.</p>
<p>So, let’s first look at the capability of PHY/MAC in my hand.</p>
<p>The PHY was provided by Atheros AR8031 as Ethernet transceiver and Atheros AR8327 as Ethernet switch.</p>
<ul>
<li>Compatible with IEEE Standard 802.3.</li>
<li>Full duplex operation 1000 Mbps operation speeds.</li>
<li>Statistics counter registers for RMON/MIB.</li>
<li>Embedded DMA.</li>
<li>Only for SGMII: Integrated Physical Coding Sub-layer (PCS) with auto-negotiation.</li>
<li>MDIO interface provided to control external phys from the Embedded RISC processor.</li>
<li>Automatic pad and cyclic redundancy check (CRC) generation on transmitted frames.</li>
<li>Automatic discard of frames received with errors.</li>
<li>Receive and transmit IP, TCP and UDP checksum offload. Both IPv4 and IPv6 packet types supported.</li>
<li>Address checking logic for four specific 48-bit addresses, four types of Ids, promiscuous mode, external<br>address checking, hash matching for unicast and multicast destination addresses and Wake-on-LAN.</li>
<li>Programmable IPG stretch.</li>
<li>Support for 802.1Q VLAN tagging with recognition of incoming VLAN and priority tagged frames.</li>
<li>Support for 802.1Qbb priority-based flow control – PFC Negotiation mode.</li>
<li>Full utilization of the Tx 1 Gbps line.</li>
<li>Provides sufficient buffer 16KB to support lossless reception of maximum length (jumbo-type) up to 10,240Bytes Ethernet frames.</li>
<li>For RGMII only: RGMII electrical characteristics compliant with RGMII v1.3 (thus based upon 2.5V CMOS interface voltages as defined by JEDEC EIA/JESD8-5), and are not compliant with RGMII v2.0.</li>
<li>Support for 1588 V1/V2.</li>
<li>Support for 802.3az Energy Efficient Ethernet</li>
</ul>
<p>Some advanced features which attract on me were:</p>
<ul>
<li>Statistics counter registers for RMON/MIB. (then we can get performance comparison on the MAC level, great feature.)</li>
<li>Programmable IPG stretch.</li>
<li>Checksum offload.</li>
<li>Automatic padding and CRC generation.</li>
<li>10KB buffer!</li>
<li>Sctter-Gather capability!</li>
</ul>
<h2 id="Do-it"><a href="#Do-it" class="headerlink" title="Do it"></a>Do it</h2><p>In this embedded project, it was not allowed 3rd organization/person install/uninstall any package without authorization, which was guaranteed by the Trust Zone Area, it means any installed package after HASH self-signed must be verified by the public key install on this area, otherwise it will failed to get install or upgrade. </p>
<p>What I want to said was - we trust the software installed on the board. Then it means we don’t need to consider the security issues mentioned in the 2nd article. Then we can simplify our design without considering security.</p>
<p>Some highlight feature include:</p>
<ul>
<li>Direct linear address mapping (vir2phy, phy2vir). support more than one page size space.</li>
<li>Zero-copy from filling the message in user space to sending message into the device in kernel space. (This GMAC support scatter-gather functionality , and the kernel later than 2.6.xx support the scatter-gather functionality)</li>
<li>Public API to application in user space, another public API to device driver in kernel module.</li>
<li>It provide a simple memory cache scheme in user space level, decreasing the system trap call on most circumstances. as well as it will re-fill/request to the memory pool if the threshold reached, one system call was happened only till this time.</li>
<li>It expose more detailed real-time information in /proc file-system. </li>
</ul>
<p>Some aspects need to consider in front of project are:</p>
<ul>
<li>Memory access time is unpredictable.</li>
<li>Memory bandwidth is limited.</li>
<li>Data change between application is very high.</li>
<li>Lifetime of exchanging data was short. (get/put)</li>
<li>Linux use page table translation to get better protection, which means it was not so straightforward to access memory.</li>
<li>Other hardware limitation, (System BUS bandwidth, MAC interface).</li>
</ul>
<p>These limitations/requirements decide the way what we do.  </p>
<p>In purpose of better memory management between kernel space and user space, we setup a raw virtual device with fixed I/O start address and length when start kernel, then both user space application which can use mmap() mapping the I/O space to its own virtual address and kernel module can access the same memory address via the fixed offset.</p>
<p>There are some inherent access attributes on those memory, so it is necessary to have a test on which cache scheme was best suit for our requirement.</p>
<img src="/2017/06/05/Efficient-data-transfer-through-zero-copy/cache-02.png" alt="Picture-01" title="Picture-01">
<p>For achieve the best system efficiency: </p>
<ul>
<li>Use L1-only cached memory.</li>
<li>Zero-copy whenever possible.</li>
<li>Minimize number of system calls and context switch.</li>
</ul>
<p>So, let’s have a look at this picture show:<br><img src="/2017/06/05/Efficient-data-transfer-through-zero-copy/zero-copy.png" alt="Picture-02" title="Picture-02"></p>
<h2 id="Design-details"><a href="#Design-details" class="headerlink" title="Design details"></a>Design details</h2><h2 id="End"><a href="#End" class="headerlink" title="End"></a>End</h2><p>Actually, in our products, other module/process also use this POOL as hot-fast data storage, such like we develop the fsyslog which was an log framework providing the functions like syslogd(…) in Unix but it provide shared-memory based logging scheme with faster and non-blocking operation when logging in user application, etc. </p>
<p>Later I will show the comparison after this changes, which achieving more than 30% throughput boost in whole and 2% load decrease in our specified product.</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Zero-copy-I-O-practice-in-project&quot;&gt;&lt;a href=&quot;#Zero-copy-I-O-practice-in-project&quot; class=&quot;headerlink&quot; title=&quot;Zero-copy I/O practice in project&quot;&gt;&lt;/a&gt;Zero-copy I/O practice in project&lt;/h2&gt;&lt;p&gt;Recently weeks, I was working on how to exploit the potentialities with the GMAC(1G Ethernet Media Access Controller)  on the SoC in my desktop. This SoC was used in the telecommunication field which provide the fast-transfer-data capability with some interesting MAC features. In this article, I had like share some experiences on how to utilize this MAC achieving better network throughput during this work.&lt;/p&gt;
&lt;h2 id=&quot;Preface&quot;&gt;&lt;a href=&quot;#Preface&quot; class=&quot;headerlink&quot; title=&quot;Preface&quot;&gt;&lt;/a&gt;Preface&lt;/h2&gt;&lt;p&gt;@[Blog]&lt;/p&gt;
&lt;p&gt;The following articles were worth having a look before going forward.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.linuxjournal.com/article/6345&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Zero Copy I: User-Mode Perspective &lt;/a&gt; (from Linux Journal, strongly recommended to read)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://dl.acm.org/citation.cfm?id=974947&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;An Efficient Zero-Copy I/O Framework for UNIX&lt;/a&gt; (most of thoughts comes from here)&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>don&#39;t use memset() init your struct</title>
    <link href="https://eshenhu.github.io/2017/06/04/don-t-use-memset-init-your-struct/"/>
    <id>https://eshenhu.github.io/2017/06/04/don-t-use-memset-init-your-struct/</id>
    <published>2017-06-04T14:17:59.000Z</published>
    <updated>2017-06-04T15:58:53.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Don’t-use-memset-init-your-struct"><a href="#Don’t-use-memset-init-your-struct" class="headerlink" title="Don’t use memset init your struct"></a>Don’t use memset init your struct</h2><p>Even in some open source project, we always see <code>memset</code> filled in the code, here I had like give the reason why we should not use <code>memset</code> if possible.</p>
<a id="more"></a>
<ul>
<li><p><code>memset</code> was subject to give side-effect to your code.<br><a href="http://en.cppreference.com/w/c/string/byte/memset" target="_blank" rel="external">memset description</a><br>In some projects, <code>memset</code> was used to flush the struct,<br>like the example given here <a href="https://linux.die.net/man/2/bind" target="_blank" rel="external">bind example given in die.net</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> sfd, cfd;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">my_addr</span>, <span class="title">peer_addr</span>;</span></div><div class="line">    ...</div><div class="line">    <span class="built_in">memset</span>(&amp;my_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_un));</div><div class="line">                        <span class="comment">/* Clear structure */</span></div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>memset</code> will flush with byte by byte in your raw memory. in such situations, only <code>0</code> or possible <code>0xFF</code> was allowed, otherwise you will get some results more than what you expected.<br>Some examples like this one: <a href="http://stackoverflow.com/questions/7202411/why-does-memsetarr-1-sizeofarr-sizeofint-not-clear-an-integer-array-t" target="_blank" rel="external">good example</a></p>
</li>
<li><p><code>memset</code> was not efficient than the other solution.<br><code>memset</code> will have one function call  when use it.<br>I will take this struct as example:</p>
<img src="/2017/06/04/don-t-use-memset-init-your-struct/example.png" alt="example code" title="example code">
<p>Disassemble code on the x86-64 arch machine.</p>
<img src="/2017/06/04/don-t-use-memset-init-your-struct/disassemble-01.png" alt="disassemble-01" title="disassemble-01">
<p>how we handle this with more elegant manner?<br>Use initlization!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">struct sockaddr_un myaddr = &#123;&#125;;</div></pre></td></tr></table></figure>
<p>Have a look at the disassemble code:</p>
<img src="/2017/06/04/don-t-use-memset-init-your-struct/disassemble-02.png" alt="disassemble-02" title="disassemble-02">
<p>Oops, it just use less code to finish this flush operation!</p>
<p>Don’t use memset anymore!</p>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Don’t-use-memset-init-your-struct&quot;&gt;&lt;a href=&quot;#Don’t-use-memset-init-your-struct&quot; class=&quot;headerlink&quot; title=&quot;Don’t use memset init your struct&quot;&gt;&lt;/a&gt;Don’t use memset init your struct&lt;/h2&gt;&lt;p&gt;Even in some open source project, we always see &lt;code&gt;memset&lt;/code&gt; filled in the code, here I had like give the reason why we should not use &lt;code&gt;memset&lt;/code&gt; if possible.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Language" scheme="https://eshenhu.github.io/tags/Language/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://eshenhu.github.io/2017/06/04/hello-world/"/>
    <id>https://eshenhu.github.io/2017/06/04/hello-world/</id>
    <published>2017-06-04T04:27:23.000Z</published>
    <updated>2017-06-04T04:27:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
    
    </summary>
    
    
  </entry>
  
</feed>
