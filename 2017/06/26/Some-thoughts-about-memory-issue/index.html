<!DOCTYPE html><html lang="en-Us"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C" /><title> Some thoughts about memory issue · eshenhu's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Some thoughts about memory issue - eshenhu"><meta name="keywords"><meta name="author" content="eshenhu"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://eshenhu.github.io/atom.xml" title="eshenhu's blog"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/categories/live/" target="_self" data-hover="生活" class="nav-list-link">生活</a></li><li class="nav-list-item"><a href="/categories/film/" target="_self" data-hover="摄影" class="nav-list-link">摄影</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Some thoughts about memory issue</h1><div class="post-info">2017-06-26 22:27</div><div class="post-content"><p>最近一段时间在忙于内存问题的事情，算是有些成果输出吧。借机谈论一下自己的感想。</p>
<p>近来工程团队遇到几次比较严重的内存泄漏问题,有一些问题无疾而终.在接手工作后发现这些问题均是发生<br>在客户的现场,很难在实验室复现. 即使能够在长时间stability测试发现问题，因为现场发生比较遥远，<br>也是很难去定位问题. 针对此类问题,团队近期输出了几个内部产品, 较好的解决了其中的一些问题。</p>
<a id="more"></a>
<p>项目团队在 Devops team 的协助下已经有一套比较完备的测试工具, 单元测试，valgrind内存检查.<br>但是在集成测试阶段还是缺乏手段去快速定位内存问题。针对此类问题</p>
<ul>
<li>工程团队重构了自定义的内存分配器，加入了头尾两部分的magic number, FREE() 内存后reset<br>内存单元内容. 在每次 ALLOC()/FREE() 强制检查合法性, 第一时间保留现场.</li>
<li>针对 wild pointer visit 的棘手问题的时候, 工程团队兵分两路. 一路从现有的集成测试出发，<br>使用valgrind工具编译代码直接进入集成测试阶段进行验证.针对实时性很强的部分进行stub处理.<br>另外一路，从系统角度，引入 <code>dynamic memory check</code>. 大致原理是binding 一个实时性可以调整<br>的background线程, 使用kernel调度进行实时性内存检查, 一旦发生内存越界 magic number over<br>ride 情况立刻报告. 实时性视内存问题严重性选择可调.</li>
<li>统计内存泄漏问题，输出了一个增强功能，主要是在内存分配阶段增加extra struct 到历史容器<br>存储. 添加<strong>FUNCTION</strong>, <strong>LINENUMBER</strong>, 方便定位问题.</li>
<li>集成测试采用震荡的方式进行用例测试，放大内存泄漏问题. 使用 snapshot 功能定制差异比较.</li>
<li>和Devops团队合作把内存检查当作必要测试添加到robust测试用例当中.</li>
</ul>
<p>通过工程团队的一段时间的持续改进,一些问题在后续的解决过程中得到效率的提升.</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Language/" style="font-size: 10px;">Language</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/23/Fast-logging-system-in-embedded-system/">Fast logging system in embedded system</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/16/System-test-thoughts/">system test thoughts</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/Some-thoughts-about-memory-issue/">Some thoughts about memory issue</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/05/Efficient-data-transfer-through-zero-copy/">Efficient data transfer through zero copy</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/04/don-t-use-memset-init-your-struct/">don't use memset() init your struct</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2017/08/16/System-test-thoughts/" class="prev">PREV</a><a href="/2017/06/05/Efficient-data-transfer-through-zero-copy/" class="next">NEXT</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script>var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "",
    productKey: "656e246ebfc7420d82eb5d9a339b50c2",
    target: "cloud-tie-wrapper"
};</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><div class="copyright"><p>© 2016 - 2017 <a target="_blank">eshenhu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a>.</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>