<!DOCTYPE html><html lang="en-Us"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><title> SMEM,SMD,SMSM 1/3 · eshenhu's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="SMEM,SMD,SMSM 1/3 - eshenhu"><meta name="keywords"><meta name="author" content="eshenhu"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://eshenhu.github.io/atom.xml" title="eshenhu's blog"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/categories/live/" target="_self" data-hover="生活" class="nav-list-link">生活</a></li><li class="nav-list-item"><a href="/categories/film/" target="_self" data-hover="摄影" class="nav-list-link">摄影</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">SMEM,SMD,SMSM 1/3</h1><div class="post-info">2018-12-05 22:58</div><div class="post-content"><h1 id="SMEM-SMD-SMSM-1-3"><a href="#SMEM-SMD-SMSM-1-3" class="headerlink" title="SMEM,SMD,SMSM (1/3)"></a>SMEM,SMD,SMSM (1/3)</h1><p>Recent half of year, I made development on Qualcomm platform FSM990x, which is ARM A7 based, same core with Mobile phone a few years ago, but equipped with more powerful DSP and FPGA capability for special purpose.</p>
<p>In the Qualcomm SDK, there are some concepts which need to be learned with some effort. I had like share my thoughts on SMEM, SMD,SMSM and QMI in following series of articles.</p>
<h2 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h2><p>In the Kernel tree, there is a brief introduction on SMEM,SMD,SMSM in the soc/qcom/qcom,smem.txt, But it has little hard to understand what is the purpose and usage on SMEM,SMD,SMSM in Qualcomm platform, I’d like share my thought on this topic.</p>
<p>@<a href="https://elixir.bootlin.com/linux/v4.4.97/source/Documentation/devicetree/bindings/soc/qcom/qcom,smem.txt" target="_blank" rel="noopener">SMEM</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Qualcomm Shared Memory Manager binding</span><br><span class="line">This binding describes the Qualcomm Shared Memory Manager, used to share data</span><br><span class="line">between various subsystems and OSes in Qualcomm platforms.</span><br></pre></td></tr></table></figure></p>
<p>@<a href="https://elixir.bootlin.com/linux/v4.4.97/source/Documentation/devicetree/bindings/soc/qcom/qcom,smd.txt" target="_blank" rel="noopener">SMD</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Qualcomm Shared Memory Driver (SMD) binding</span><br><span class="line"></span><br><span class="line">This binding describes the Qualcomm Shared Memory Driver, a fifo based</span><br><span class="line">communication channel for sending data between the various subsystems in</span><br><span class="line">Qualcomm platforms.</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<h2 id="SMEM"><a href="#SMEM" class="headerlink" title="SMEM"></a>SMEM</h2><p>Qualcomm Soc has some heterogeneous process units inside, like DSP, Modem, etc. For better message transfer, Qualcomm use _shared_memory_ and <em>interrupt</em> to interchange the control message (not the user plane message, as SMEM is not purposed on that, Qualcomm provide HW FIFO or DMA on that purpose which provide more throughput than SMEM based method like QMI, etc. It also not suitable to use SMEM to interchange the message requiring high throughput? – I think it still practical to use _shared<em>memory</em> to interchange high throughput data with <em>PUSH-PULL</em> model instead of SMEM message notification scheme, anyway HW support FIFO it has some other advantages over _shared<em>memory</em>). </p>
<p>The Interface exposed by SMEM:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">enum id&#123;</span><br><span class="line">	/* fixed items */</span><br><span class="line">	SMEM_PROC_COMM = 0,</span><br><span class="line">	SMEM_HEAP_INFO,</span><br><span class="line">	SMEM_ALLOCATION_TABLE,</span><br><span class="line">	SMEM_VERSION_INFO,</span><br><span class="line">	SMEM_HW_RESET_DETECT,</span><br><span class="line">	SMEM_AARM_WARM_BOOT,</span><br><span class="line">	....</span><br><span class="line">    /* dynamic items */</span><br><span class="line">	...</span><br><span class="line">	SMEM_AARM_PARTITION_TABLE,</span><br><span class="line">	SMEM_AARM_BAD_BLOCK_TABLE,</span><br><span class="line">	SMEM_ERR_CRASH_LOG_ADSP,</span><br><span class="line">	SMEM_WM_UUID,</span><br><span class="line">	SMEM_CHANNEL_ALLOC_TBL,</span><br><span class="line">	SMEM_SMD_BASE_ID,</span><br><span class="line">	...</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void *smem_alloc(enum id, unsigned size_in, unsigned to_proc,</span><br><span class="line">								unsigned flags);</span><br><span class="line">void *smem_find(enum id, unsigned size_in, unsigned to_proc,</span><br><span class="line">								unsigned flags);</span><br></pre></td></tr></table></figure></p>
<p>@id       is ID of SEME item;</p>
<p>@size_in  size of the SMEM item;</p>
<p>@to_proc  SMEM host that shares the item with apps, in the host, SMEM make<br>partitions for each <em>SUBSYSTEM</em> such like, DSP, Modem etc, in each partition<br>they have same allocation patterns, but in some scenarios, <em>FLAG</em> with<br><em>SMEM_ANY_HOST_FLAG</em> will indicatethe <em>smem_alloc</em> to use the <em>shared space</em> in top of the space for allocation. <em>SMEM_ANY_HOST_FLAG</em> means this space was<br>depended with any subsystems and can be used by any partition.</p>
<p>@flags    Item attribute flags<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Flag options for the XXX_to_proc() API</span><br><span class="line"> *</span><br><span class="line"> * SMEM_ITEM_CACHED_FLAG - Indicates this operation should use cachable smem</span><br><span class="line"> *</span><br><span class="line"> * SMEM_ANY_HOST_FLAG - Indicates this operation should not apply to smem items</span><br><span class="line"> *                      which are limited to a specific host pairing.  Will</span><br><span class="line"> *                      cause this operation to ignore the to_proc parameter.</span><br><span class="line"> */</span><br><span class="line">\#define SMEM_ITEM_CACHED_FLAG 1</span><br><span class="line">\#define SMEM_ANY_HOST_FLAG 2</span><br></pre></td></tr></table></figure></p>
<p>SMEM maint a <em>cached</em> and <em>uncached</em> space in the secute space, the cacheable<br>space was aligned with the <em>cache</em> size in the <em>header</em> declared, my guess is<br>because some subsystems were required with alignment of the memory.<br>As far as <em>SMEM_ANY_HOST_FLAG</em>, I had already explained in the last section.</p>
<h3 id="Structure-of-smem"><a href="#Structure-of-smem" class="headerlink" title="Structure of smem"></a>Structure of smem</h3><img src="/2018/12/05/SMEM-SMD-SMSM-1-3/smem.png" title="c++code">
<p><em>smem</em> platform driver use Device Tree to parse the memory layout. f.g.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">qcom,smem@13600000 &#123;</span><br><span class="line">	compatible = &quot;qcom,smem&quot;;</span><br><span class="line">	reg = &lt;0x13600000 0x200000&gt;,</span><br><span class="line">		&lt;0xf9011000 0x1000&gt;;</span><br><span class="line">	reg-names = &quot;smem&quot;, &quot;irq-reg-base&quot;;</span><br><span class="line"></span><br><span class="line">	qcom,smd-hex0 &#123;</span><br><span class="line">		compatible = &quot;qcom,smd&quot;;</span><br><span class="line">		qcom,smd-edge = &lt;0&gt;;</span><br><span class="line">		qcom,smd-irq-offset = &lt;0x8&gt;;</span><br><span class="line">		qcom,smd-irq-bitmask = &lt;0x100&gt;;</span><br><span class="line">		interrupts = &lt;0 72 1&gt;;</span><br><span class="line">		label = &quot;hex0&quot;;</span><br><span class="line">		qcom,not-loadable;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	qcom,smd-hex1 &#123;</span><br><span class="line">		compatible = &quot;qcom,smd&quot;;</span><br><span class="line">		qcom,smd-edge = &lt;1&gt;;</span><br><span class="line">		qcom,smd-irq-offset = &lt;0x8&gt;;</span><br><span class="line">		qcom,smd-irq-bitmask = &lt;0x1000&gt;;</span><br><span class="line">		interrupts = &lt;0 68 1&gt;;</span><br><span class="line">		label = &quot;hex1&quot;;</span><br><span class="line">		qcom,not-loadable;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	qcom,smd-tenx &#123;</span><br><span class="line">		compatible = &quot;qcom,smd&quot;;</span><br><span class="line">		qcom,smd-edge = &lt;10&gt;;</span><br><span class="line">		qcom,smd-irq-offset = &lt;0x8&gt;;</span><br><span class="line">		qcom,smd-irq-bitmask = &lt;0x10&gt;;</span><br><span class="line">		interrupts = &lt;0 26 1&gt;;</span><br><span class="line">		label = &quot;tenx&quot;;</span><br><span class="line">		qcom,not-loadable;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>From the node above, dt declare a qcom,smem node with memory phy_addr-size {0x13600000-0x200000} and IRQ reg phy_addr-size {0xf9011000-0x1000}. The driver use ioremap_nocache(…) to map to virtual address.</p>
<p>In some SoC variants, Qualcomm declare <em>aux-%1</em> in dts file, smem reserve the spaces for them when co-processor happened <em>RESTART</em> it can dump the ELF file image aka. <em>ramdump</em>. In such cases, SMEM will create the stucture to describe them as well.</p>
<h4 id="security-zone-amp-non-security-zone"><a href="#security-zone-amp-non-security-zone" class="headerlink" title="security zone &amp; non-security zone"></a>security zone &amp; non-security zone</h4><p>SMEM part 2 different zones for whole available ram space, SMEM define a enum to describe that <em>fixed items</em> should be allocated in security zone, and <em>dynamic item</em> should be allocated in non-security zone.</p>
<h3 id="More-options"><a href="#More-options" class="headerlink" title="More options"></a>More options</h3><p>I had like make a compare with other SoC vendor how they handle such IPC between heterogeneous system, as far as I know, like TI, Xilinx currently they would like use <em>RPMSG</em> <a href="https://www.kernel.org/doc/Documentation/rpmsg.txt" target="_blank" rel="noopener">here</a> based on virtio as backend. RPMSG is also a shared memory (virtqueue) based tech.</p>
<p>Qualcomm use SMEM as backend to extend some basic services like SMD, SMEM etc.</p>
<p>I will talk about that in the next ariticle.</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Language/" style="font-size: 10px;">Language</a> <a href="/tags/Linux-Kernel-Module/" style="font-size: 10px;">Linux Kernel Module</a> <a href="/tags/Qualcomm/" style="font-size: 10px;">Qualcomm,</a> <a href="/tags/SIPTO-LIPA-IMobile-Data-Offloading/" style="font-size: 10px;">SIPTO LIPA IMobile Data Offloading</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/20/eTrice/">eTrice (A open source ROOM framework for simplify your work)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/18/Golang-race-condition-detection-result-will-not-happene-always/">Golang-race-condition-detection-result-will-not-happene-always</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/05/SMEM-SMD-SMSM-1-3/">SMEM,SMD,SMSM 1/3</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/01/Drgon-ball-release-their-code-to-explain-the-reason-cool/">Drgon ball release their code to explain the reason, cool</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/12/Write-a-HW-based-periodic-timer-framework/">Write a HW based periodic timer framework</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2019/02/18/Golang-race-condition-detection-result-will-not-happene-always/" class="prev">PREV</a><a href="/2018/11/01/Drgon-ball-release-their-code-to-explain-the-reason-cool/" class="next">NEXT</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script>var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "",
    productKey: "656e246ebfc7420d82eb5d9a339b50c2",
    target: "cloud-tie-wrapper"
};</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><div class="copyright"><p>© 2016 - 2019 <a target="_blank">eshenhu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a>.</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>