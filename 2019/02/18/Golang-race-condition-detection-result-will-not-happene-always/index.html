<!DOCTYPE html><html lang="en-Us"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><title> Golang-race-condition-detection-result-will-not-happene-always · eshenhu's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Golang-race-condition-detection-result-will-not-happene-always - eshenhu"><meta name="keywords"><meta name="author" content="eshenhu"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://eshenhu.github.io/atom.xml" title="eshenhu's blog"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/categories/live/" target="_self" data-hover="生活" class="nav-list-link">生活</a></li><li class="nav-list-item"><a href="/categories/film/" target="_self" data-hover="摄影" class="nav-list-link">摄影</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Golang-race-condition-detection-result-will-not-happene-always</h1><div class="post-info">2019-02-18 21:49</div><div class="post-content"><p>[TOC]</p>
<p>Dave Cheney post a <a href="https://dave.cheney.net/2015/11/18/wednesday-pop-quiz-spot-the-race" target="_blank" rel="noopener">quiz</a> on his blog several years ago, </p>
<p><a href="http://play.golang.org/p/tjN4I_VTV0" target="_blank" rel="noopener">code</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">        <span class="string">"fmt"</span></div><div class="line">        <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> RPC <span class="keyword">struct</span> &#123;</div><div class="line">        result <span class="keyword">int</span></div><div class="line">        done   <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rpc *RPC)</span> <span class="title">compute</span><span class="params">()</span></span> &#123;</div><div class="line">        time.Sleep(time.Second) <span class="comment">// strenuous computation intensifies</span></div><div class="line">        rpc.result = <span class="number">42</span></div><div class="line">        <span class="built_in">close</span>(rpc.done)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(RPC)</span> <span class="title">version</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span> <span class="comment">// never going to need to change this</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">        rpc := &amp;RPC&#123;done: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)&#125;</div><div class="line"></div><div class="line">        <span class="keyword">go</span> rpc.compute()         <span class="comment">// kick off computation in the background</span></div><div class="line">        version := rpc.version() <span class="comment">// grab some other information while we're waiting</span></div><div class="line">        &lt;-rpc.done               <span class="comment">// wait for computation to finish</span></div><div class="line">        result := rpc.result</div><div class="line"></div><div class="line">        fmt.Printf(<span class="string">"RPC computation complete, result: %d, version: %d\n"</span>, result, version)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>When you use <em>race</em> tool to run it, it will give you warning as following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">~/W/g/c/src ❯❯❯ go run -race race.go</div><div class="line">rpc addr = 0xc0000961c0</div><div class="line">version = 2</div><div class="line">==================</div><div class="line">WARNING: DATA RACE</div><div class="line">Write at 0x00c0000961c0 by goroutine 6:</div><div class="line">  main.(*RPC).compute()</div><div class="line">      /Users/andrewhoo/Work/go/codeschool/src/race.go:15 +0x3a</div><div class="line"></div><div class="line">Previous read at 0x00c0000961c0 by main goroutine:</div><div class="line">  main.main()</div><div class="line">      /Users/andrewhoo/Work/go/codeschool/src/race.go:28 +0x163</div><div class="line"></div><div class="line">Goroutine 6 (running) created at:</div><div class="line">  main.main()</div><div class="line">      /Users/andrewhoo/Work/go/codeschool/src/race.go:27 +0x14c</div><div class="line">==================</div><div class="line">RPC computation complete, result: 42, version: 1</div><div class="line">Found 1 data race(s)</div><div class="line">exit status 66</div></pre></td></tr></table></figure>
<p>This code share the variable <code>rpc</code> on 2 goroutines, race tool give its detection result. But is it really a race-condition in the code? </p>
<p>After change the Line 32 code into:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rpc *RPC)</span> <span class="title">version</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span> <span class="comment">// never going to need to change this</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Race tool will not complain the race-condition. But when you compile the code without race tools into assemble language, it show nothing different on this line of code as this line of code was optimized away by the compiler.</p>
<p>But why the golang race-detection tool do such complaints?</p>
<p>Let’s show what race-detection tool do:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">version := rpc.version() // grab some other information while we&apos;re waiting</div><div class="line">  0x10f712d             488b442440              MOVQ 0x40(SP), AX</div><div class="line">  0x10f7132             48890424                MOVQ AX, 0(SP)</div><div class="line">  0x10f7136             48c744240810000000      MOVQ $0x10, 0x8(SP)</div><div class="line">  0x10f713f             e8cc44f9ff              CALL runtime.racereadrange(SB)</div></pre></td></tr></table></figure>
<p>Golang use <a href="https://github.com/google/sanitizers" target="_blank" rel="noopener">ThreadSanitizer</a> to detect the possible race-conditions. Obviously, the ASM show the tools take the whole <code>RPC</code> struct as one protected unit if you use the <code>struct RPC</code> as the operation object, This explain the reason when the line 28 code change the member of this global variable, it will violate the <code>State Machine Code</code> code made by the Sanitizer. But actually it will not happen such race-condition case.</p>
<p>Anyway this code need to be refactor, try not to use global variable between goroutines except you have enough reasons to do that.</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Language/" style="font-size: 10px;">Language</a> <a href="/tags/Linux-Kernel-Module/" style="font-size: 10px;">Linux Kernel Module</a> <a href="/tags/Qualcomm/" style="font-size: 10px;">Qualcomm,</a> <a href="/tags/SIPTO-LIPA-IMobile-Data-Offloading/" style="font-size: 10px;">SIPTO LIPA IMobile Data Offloading</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/18/Golang-race-condition-detection-result-will-not-happene-always/">Golang-race-condition-detection-result-will-not-happene-always</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/05/SMEM-SMD-SMSM-1-3/">SMEM,SMD,SMSM 1/3</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/01/Drgon-ball-release-their-code-to-explain-the-reason-cool/">Drgon ball release their code to explain the reason, cool</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/12/Write-a-HW-based-periodic-timer-framework/">Write a HW based periodic timer framework</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/22/Use-DPDK-to-accelerate-LTE-networks/">Use DPDK to accelerate LTE networks</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/12/05/SMEM-SMD-SMSM-1-3/" class="next">NEXT</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script>var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "",
    productKey: "656e246ebfc7420d82eb5d9a339b50c2",
    target: "cloud-tie-wrapper"
};</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><div class="copyright"><p>© 2016 - 2019 <a target="_blank">eshenhu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a>.</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>