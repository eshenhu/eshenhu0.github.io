<!DOCTYPE html><html lang="en-Us"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><title> Golang-race-condition-detection-result-will-not-happene-always · eshenhu's blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Golang-race-condition-detection-result-will-not-happene-always - eshenhu"><meta name="keywords"><meta name="author" content="eshenhu"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://eshenhu.github.io/atom.xml" title="eshenhu's blog"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/categories/live/" target="_self" data-hover="生活" class="nav-list-link">生活</a></li><li class="nav-list-item"><a href="/categories/film/" target="_self" data-hover="摄影" class="nav-list-link">摄影</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Golang-race-condition-detection-result-will-not-happene-always</h1><div class="post-info">2019-02-18 21:49</div><div class="post-content"><p>[TOC]</p>
<p>Dave Cheney post a <a href="https://dave.cheney.net/2015/11/18/wednesday-pop-quiz-spot-the-race" target="_blank" rel="noopener">quiz</a> on his blog several years ago, </p>
<p><a href="http://play.golang.org/p/tjN4I_VTV0" target="_blank" rel="noopener">code</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"fmt"</span></span><br><span class="line">        <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RPC <span class="keyword">struct</span> &#123;</span><br><span class="line">        result <span class="keyword">int</span></span><br><span class="line">        done   <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rpc *RPC)</span> <span class="title">compute</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(time.Second) <span class="comment">// strenuous computation intensifies</span></span><br><span class="line">        rpc.result = <span class="number">42</span></span><br><span class="line">        <span class="built_in">close</span>(rpc.done)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(RPC)</span> <span class="title">version</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> <span class="comment">// never going to need to change this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        rpc := &amp;RPC&#123;done: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">go</span> rpc.compute()         <span class="comment">// kick off computation in the background</span></span><br><span class="line">        version := rpc.version() <span class="comment">// grab some other information while we're waiting</span></span><br><span class="line">        &lt;-rpc.done               <span class="comment">// wait for computation to finish</span></span><br><span class="line">        result := rpc.result</span><br><span class="line"></span><br><span class="line">        fmt.Printf(<span class="string">"RPC computation complete, result: %d, version: %d\n"</span>, result, version)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>When you use <em>race</em> tool to run it, it will give you warning as following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~/W/g/c/src ❯❯❯ go run -race race.go</span><br><span class="line">rpc addr = 0xc0000961c0</span><br><span class="line">version = 2</span><br><span class="line">==================</span><br><span class="line">WARNING: DATA RACE</span><br><span class="line">Write at 0x00c0000961c0 by goroutine 6:</span><br><span class="line">  main.(*RPC).compute()</span><br><span class="line">      /Users/andrewhoo/Work/go/codeschool/src/race.go:15 +0x3a</span><br><span class="line"></span><br><span class="line">Previous read at 0x00c0000961c0 by main goroutine:</span><br><span class="line">  main.main()</span><br><span class="line">      /Users/andrewhoo/Work/go/codeschool/src/race.go:28 +0x163</span><br><span class="line"></span><br><span class="line">Goroutine 6 (running) created at:</span><br><span class="line">  main.main()</span><br><span class="line">      /Users/andrewhoo/Work/go/codeschool/src/race.go:27 +0x14c</span><br><span class="line">==================</span><br><span class="line">RPC computation complete, result: 42, version: 1</span><br><span class="line">Found 1 data race(s)</span><br><span class="line">exit status 66</span><br></pre></td></tr></table></figure>
<p>This code share the variable <code>rpc</code> on 2 goroutines, race tool give its detection result. But is it really a race-condition in the code? </p>
<p>After change the Line 32 code into:<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rpc *RPC)</span> <span class="title">version</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> <span class="comment">// never going to need to change this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Race tool will not complain the race-condition. But when you compile the code without race tools into assemble language, it show nothing different on this line of code as this line of code was optimized away by the compiler.</p>
<p>But why the golang race-detection tool do such complaints?</p>
<p>Let’s show what race-detection tool do:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">version := rpc.version() // grab some other information while we&apos;re waiting</span><br><span class="line">  0x10f712d             488b442440              MOVQ 0x40(SP), AX</span><br><span class="line">  0x10f7132             48890424                MOVQ AX, 0(SP)</span><br><span class="line">  0x10f7136             48c744240810000000      MOVQ $0x10, 0x8(SP)</span><br><span class="line">  0x10f713f             e8cc44f9ff              CALL runtime.racereadrange(SB)</span><br></pre></td></tr></table></figure>
<p>Golang use <a href="https://github.com/google/sanitizers" target="_blank" rel="noopener">ThreadSanitizer</a> to detect the possible race-conditions. Obviously, the ASM show the tools take the whole <code>RPC</code> struct as one protected unit if you use the <code>struct RPC</code> as the operation object, This explain the reason when the line 28 code change the member of this global variable, it will violate the <code>State Machine Code</code> code made by the Sanitizer. But actually it will not happen such race-condition case.</p>
<p>Anyway this code need to be refactor, try not to use global variable between goroutines except you have enough reasons to do that.</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Language/" style="font-size: 10px;">Language</a> <a href="/tags/Linux-Kernel-Module/" style="font-size: 10px;">Linux Kernel Module</a> <a href="/tags/Qualcomm/" style="font-size: 10px;">Qualcomm,</a> <a href="/tags/SIPTO-LIPA-IMobile-Data-Offloading/" style="font-size: 10px;">SIPTO LIPA IMobile Data Offloading</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/20/eTrice/">eTrice (A open source ROOM framework for simplify your work)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/18/Golang-race-condition-detection-result-will-not-happene-always/">Golang-race-condition-detection-result-will-not-happene-always</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/05/SMEM-SMD-SMSM-1-3/">SMEM,SMD,SMSM 1/3</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/01/Drgon-ball-release-their-code-to-explain-the-reason-cool/">Drgon ball release their code to explain the reason, cool</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/12/Write-a-HW-based-periodic-timer-framework/">Write a HW based periodic timer framework</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2019/08/20/eTrice/" class="prev">PREV</a><a href="/2018/12/05/SMEM-SMD-SMSM-1-3/" class="next">NEXT</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script>var cloudTieConfig = {
    url: document.location.href, 
    sourceId: "",
    productKey: "656e246ebfc7420d82eb5d9a339b50c2",
    target: "cloud-tie-wrapper"
};</script><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><div class="copyright"><p>© 2016 - 2019 <a target="_blank">eshenhu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a>.</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>